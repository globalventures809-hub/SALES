name: Deploy Ignito Edge Functions

on:
  push:
    branches: [ main ]
    paths:
      - 'ignito/functions/**'
      - 'ignito/deploy-functions.sh'
      - '.github/workflows/deploy-ignito-functions.yml'
  workflow_dispatch: {}

jobs:
  deploy-functions:
    name: Deploy Supabase Edge Functions
    runs-on: ubuntu-latest
    env:
      SUPABASE_REF: ${{ secrets.SUPABASE_REF }}
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Supabase CLI
        run: npm install -g supabase@latest

      - name: Verify Supabase CLI
        run: supabase --version

      - name: Deploy Edge Functions (ignito/functions)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_REF: ${{ secrets.SUPABASE_REF }}
        run: |
          supabase functions deploy --project-dir ./ignito/functions \
            mpesa-stk-push pesapal-create-order pesapal-callback mpesa-callback \
            --project-ref $SUPABASE_REF

      - name: Finished
        run: echo "Ignito functions deployed to $SUPABASE_REF"